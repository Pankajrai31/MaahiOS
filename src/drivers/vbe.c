/**
 * VBE (VESA BIOS Extensions) Graphics Driver
 * High-resolution graphics mode support (1024x768x32)
 */

#include <stdint.h>

/* Forward declaration */
void vbe_emergency_text_mode(void);

/* VBE Mode Information (populated by boot.s from multiboot) */
extern uint32_t vbe_mode_info[5];

/* VBE State */
static uint32_t *framebuffer = 0;
static uint32_t screen_width = 0;
static uint32_t screen_height = 0;
static uint32_t screen_pitch = 0;  // Bytes per line
static uint32_t bits_per_pixel = 0;

/* Current drawing position for text */
static int cursor_x = 0;
static int cursor_y = 0;

/* 8x16 VGA Font (subset of printable ASCII) */
static const uint8_t font_8x16[128][16] = {
    /* 0x00-0x1F: Control characters - use space */
    [0 ... 31] = {0},
    
    /* 0x20: Space */
    [32] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    
    /* 0x21: ! */
    [33] = {0x00, 0x00, 0x18, 0x3C, 0x3C, 0x3C, 0x18, 0x18,
            0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00},
    
    /* 0x22-0x2F: Basic symbols */
    [34 ... 47] = {0},  // Placeholder
    
    /* 0x30-0x39: Digits 0-9 */
    [48] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x6E, 0x76, 0x66,
            0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},  // 0
    [49] = {0x00, 0x00, 0x18, 0x38, 0x18, 0x18, 0x18, 0x18,
            0x18, 0x18, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00},  // 1
    [50] = {0x00, 0x00, 0x3C, 0x66, 0x06, 0x0C, 0x18, 0x30,
            0x60, 0x66, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00},  // 2
    [51] = {0x00, 0x00, 0x3C, 0x66, 0x06, 0x06, 0x1C, 0x06,
            0x06, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},  // 3
    [52] = {0x00, 0x00, 0x0C, 0x1C, 0x3C, 0x6C, 0x6C, 0x7E,
            0x0C, 0x0C, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00},  // 4
    [53] = {0x00, 0x00, 0x7E, 0x60, 0x60, 0x7C, 0x06, 0x06,
            0x06, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},  // 5
    [54] = {0x00, 0x00, 0x1C, 0x30, 0x60, 0x7C, 0x66, 0x66,
            0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},  // 6
    [55] = {0x00, 0x00, 0x7E, 0x66, 0x06, 0x0C, 0x18, 0x18,
            0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00},  // 7
    [56] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x3C, 0x66,
            0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},  // 8
    [57] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x3E, 0x06,
            0x06, 0x0C, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00},  // 9
    
    /* 0x3A-0x40: Punctuation */
    [58] = {0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00,
            0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},  // :
    [59 ... 64] = {0},
    
    /* 0x41-0x5A: Uppercase A-Z */
    [65] = {0x00, 0x00, 0x18, 0x3C, 0x66, 0x66, 0x66, 0x7E,
            0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00},  // A
    [66] = {0x00, 0x00, 0x7C, 0x66, 0x66, 0x66, 0x7C, 0x66,
            0x66, 0x66, 0x7C, 0x00, 0x00, 0x00, 0x00, 0x00},  // B
    [67] = {0x00, 0x00, 0x3C, 0x66, 0x60, 0x60, 0x60, 0x60,
            0x60, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},  // C
    [68] = {0x00, 0x00, 0x78, 0x6C, 0x66, 0x66, 0x66, 0x66,
            0x66, 0x6C, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00},  // D
    [69] = {0x00, 0x00, 0x7E, 0x60, 0x60, 0x60, 0x7C, 0x60,
            0x60, 0x60, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00},  // E
    [70] = {0x00, 0x00, 0x7E, 0x60, 0x60, 0x60, 0x7C, 0x60,
            0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00},  // F
    [71] = {0x00, 0x00, 0x3C, 0x66, 0x60, 0x60, 0x6E, 0x66,
            0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},  // G
    [72] = {0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x7E, 0x66,
            0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00},  // H
    [73] = {0x00, 0x00, 0x7E, 0x18, 0x18, 0x18, 0x18, 0x18,
            0x18, 0x18, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00},  // I
    [74] = {0x00, 0x00, 0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C,
            0x6C, 0x6C, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00},  // J
    [75] = {0x00, 0x00, 0x66, 0x66, 0x6C, 0x78, 0x70, 0x78,
            0x6C, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00},  // K
    [76] = {0x00, 0x00, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60,
            0x60, 0x60, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00},  // L
    [77] = {0x00, 0x00, 0x63, 0x77, 0x7F, 0x6B, 0x63, 0x63,
            0x63, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00},  // M
    [78] = {0x00, 0x00, 0x66, 0x66, 0x76, 0x7E, 0x6E, 0x66,
            0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00},  // N
    [79] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x66, 0x66,
            0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},  // O
    [80] = {0x00, 0x00, 0x7C, 0x66, 0x66, 0x66, 0x7C, 0x60,
            0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00},  // P
    [81] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x66, 0x66,
            0x6A, 0x6C, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00},  // Q
    [82] = {0x00, 0x00, 0x7C, 0x66, 0x66, 0x66, 0x7C, 0x6C,
            0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00},  // R
    [83] = {0x00, 0x00, 0x3C, 0x66, 0x60, 0x30, 0x18, 0x0C,
            0x06, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},  // S
    [84] = {0x00, 0x00, 0x7E, 0x18, 0x18, 0x18, 0x18, 0x18,
            0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00},  // T
    [85] = {0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
            0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},  // U
    [86] = {0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
            0x66, 0x3C, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00},  // V
    [87] = {0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x6B, 0x7F,
            0x77, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00},  // W
    [88] = {0x00, 0x00, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x3C,
            0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00},  // X
    [89] = {0x00, 0x00, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x18,
            0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00},  // Y
    [90] = {0x00, 0x00, 0x7E, 0x06, 0x0C, 0x18, 0x30, 0x60,
            0x60, 0x60, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00},  // Z
    
    /* 0x5B-0x60: Brackets, etc */
    [91 ... 96] = {0},
    
    /* 0x61-0x7A: Lowercase a-z */
    [97] = {0x00, 0x00, 0x00, 0x00, 0x3C, 0x06, 0x3E, 0x66,
            0x66, 0x66, 0x3E, 0x00, 0x00, 0x00, 0x00, 0x00},  // a
    [98] = {0x00, 0x00, 0x60, 0x60, 0x7C, 0x66, 0x66, 0x66,
            0x66, 0x66, 0x7C, 0x00, 0x00, 0x00, 0x00, 0x00},  // b
    [99] = {0x00, 0x00, 0x00, 0x00, 0x3C, 0x66, 0x60, 0x60,
            0x60, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},  // c
    [100] = {0x00, 0x00, 0x06, 0x06, 0x3E, 0x66, 0x66, 0x66,
             0x66, 0x66, 0x3E, 0x00, 0x00, 0x00, 0x00, 0x00},  // d
    [101] = {0x00, 0x00, 0x00, 0x00, 0x3C, 0x66, 0x66, 0x7E,
             0x60, 0x60, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},  // e
    [102] = {0x00, 0x00, 0x1C, 0x36, 0x30, 0x30, 0x7C, 0x30,
             0x30, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00},  // f
    [103] = {0x00, 0x00, 0x00, 0x00, 0x3E, 0x66, 0x66, 0x66,
             0x3E, 0x06, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00},  // g
    [104] = {0x00, 0x00, 0x60, 0x60, 0x7C, 0x66, 0x66, 0x66,
             0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00},  // h
    [105] = {0x00, 0x00, 0x18, 0x00, 0x38, 0x18, 0x18, 0x18,
             0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},  // i
    [106] = {0x00, 0x00, 0x06, 0x00, 0x06, 0x06, 0x06, 0x06,
             0x06, 0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00},  // j
    [107] = {0x00, 0x00, 0x60, 0x60, 0x66, 0x6C, 0x78, 0x78,
             0x6C, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00},  // k
    [108] = {0x00, 0x00, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18,
             0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},  // l
    [109] = {0x00, 0x00, 0x00, 0x00, 0x66, 0x7F, 0x7F, 0x6B,
             0x63, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00},  // m
    [110] = {0x00, 0x00, 0x00, 0x00, 0x7C, 0x66, 0x66, 0x66,
             0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00},  // n
    [111] = {0x00, 0x00, 0x00, 0x00, 0x3C, 0x66, 0x66, 0x66,
             0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},  // o
    [112] = {0x00, 0x00, 0x00, 0x00, 0x7C, 0x66, 0x66, 0x66,
             0x7C, 0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00},  // p
    [113] = {0x00, 0x00, 0x00, 0x00, 0x3E, 0x66, 0x66, 0x66,
             0x3E, 0x06, 0x06, 0x06, 0x00, 0x00, 0x00, 0x00},  // q
    [114] = {0x00, 0x00, 0x00, 0x00, 0x7C, 0x66, 0x60, 0x60,
             0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00},  // r
    [115] = {0x00, 0x00, 0x00, 0x00, 0x3E, 0x60, 0x60, 0x3C,
             0x06, 0x06, 0x7C, 0x00, 0x00, 0x00, 0x00, 0x00},  // s
    [116] = {0x00, 0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x18,
             0x18, 0x18, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00},  // t
    [117] = {0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x66,
             0x66, 0x66, 0x3E, 0x00, 0x00, 0x00, 0x00, 0x00},  // u
    [118] = {0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x66,
             0x66, 0x3C, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00},  // v
    [119] = {0x00, 0x00, 0x00, 0x00, 0x63, 0x63, 0x6B, 0x6B,
             0x7F, 0x36, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00},  // w
    [120] = {0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x3C, 0x18,
             0x3C, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00},  // x
    [121] = {0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x66,
             0x3E, 0x06, 0x0C, 0x78, 0x00, 0x00, 0x00, 0x00},  // y
    [122] = {0x00, 0x00, 0x00, 0x00, 0x7E, 0x06, 0x0C, 0x18,
             0x30, 0x60, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00},  // z
    
    /* 0x7B-0x7F: More symbols */
    [123 ... 127] = {0}
};

/* External VGA functions for emergency text mode */
extern void vga_clear(void);
extern void vga_print(const char *s);

/* Port I/O functions */
static inline void outb(uint16_t port, uint8_t val) {
    asm volatile("outb %0, %1" : : "a"(val), "Nd"(port));
}

static inline uint8_t inb(uint16_t port) {
    uint8_t ret;
    asm volatile("inb %1, %0" : "=a"(ret) : "Nd"(port));
    return ret;
}

/**
 * Initialize VBE driver with info from boot.s
 */
void vbe_init(void) {
    framebuffer = (uint32_t *)vbe_mode_info[0];
    screen_width = vbe_mode_info[1];
    screen_height = vbe_mode_info[2];
    screen_pitch = vbe_mode_info[3];
    bits_per_pixel = vbe_mode_info[4];
    
    cursor_x = 0;
    cursor_y = 0;
    
    /* If VBE not available or invalid, fall back to VGA text mode */
    if (framebuffer == 0 || screen_width == 0 || screen_height == 0 || screen_pitch == 0) {
        /* Force switch to VGA text mode 80x25 */
        vbe_emergency_text_mode();
        
        /* Mark VBE as unavailable */
        framebuffer = 0;
        screen_width = 0;
        screen_height = 0;
    }
}

/**
 * Get VBE framebuffer address (for identity mapping)
 */
uint32_t vbe_get_framebuffer_addr(void) {
    return (uint32_t)framebuffer;
}

/**
 * Get VBE framebuffer size in bytes
 */
uint32_t vbe_get_framebuffer_size(void) {
    return screen_pitch * screen_height;
}

/**
 * Get screen width
 */
uint32_t vbe_get_width(void) {
    return screen_width;
}

/**
 * Get screen height
 */
uint32_t vbe_get_height(void) {
    return screen_height;
}

/**
 * Draw a single pixel
 */
void vbe_putpixel(int x, int y, uint32_t color) {
    if (x < 0 || x >= (int)screen_width || y < 0 || y >= (int)screen_height)
        return;
    
    // Calculate pixel offset (pitch is in bytes, we need pixel offset)
    uint32_t *pixel = framebuffer + (y * (screen_pitch / 4) + x);
    *pixel = color;
}

/**
 * Clear screen to color
 */
void vbe_clear(uint32_t color) {
    /* If VBE not available, use VGA text mode */
    if (framebuffer == 0 || screen_width == 0) {
        extern void vga_clear(void);
        vga_clear();
        return;
    }
    
    uint32_t pixels = (screen_pitch / 4) * screen_height;
    for (uint32_t i = 0; i < pixels; i++) {
        framebuffer[i] = color;
    }
}

/**
 * Draw filled rectangle
 */
void vbe_draw_rect(int x, int y, int width, int height, uint32_t color) {
    for (int row = 0; row < height; row++) {
        for (int col = 0; col < width; col++) {
            vbe_putpixel(x + col, y + row, color);
        }
    }
}

/**
 * Draw a character at position (x, y) with foreground/background color
 */
void vbe_putchar(int x, int y, char c, uint32_t fg, uint32_t bg) {
    uint8_t uc = (uint8_t)c;
    if (uc >= 128) uc = 0;  // Invalid character, use space
    
    const uint8_t *glyph = font_8x16[uc];
    
    for (int row = 0; row < 16; row++) {
        uint8_t line = glyph[row];
        for (int col = 0; col < 8; col++) {
            uint32_t color = (line & (0x80 >> col)) ? fg : bg;
            vbe_putpixel(x + col, y + row, color);
        }
    }
}

/**
 * Print string at position with colors
 */
void vbe_print_at(int x, int y, const char *str, uint32_t fg, uint32_t bg) {
    int cx = x;
    int cy = y;
    
    while (*str) {
        if (*str == '\n') {
            cx = x;
            cy += 16;
            str++;
            continue;
        }
        
        vbe_putchar(cx, cy, *str, fg, bg);
        cx += 8;
        
        if (cx + 8 > (int)screen_width) {
            cx = x;
            cy += 16;
        }
        
        str++;
    }
}

/**
 * Print string at current cursor position
 */
void vbe_print(const char *str, uint32_t fg, uint32_t bg) {
    /* If VBE not available, use VGA text mode */
    if (framebuffer == 0 || screen_width == 0) {
        extern void vga_print(const char *s);
        vga_print(str);
        return;
    }
    
    while (*str) {
        if (*str == '\n') {
            cursor_x = 0;
            cursor_y += 16;
        } else {
            vbe_putchar(cursor_x, cursor_y, *str, fg, bg);
            cursor_x += 8;
            
            if (cursor_x + 8 > (int)screen_width) {
                cursor_x = 0;
                cursor_y += 16;
            }
        }
        
        // Scroll if needed
        if (cursor_y + 16 > (int)screen_height) {
            cursor_y = (int)screen_height - 16;
        }
        
        str++;
    }
}

/**
 * Emergency: Switch back to VGA text mode for panic messages
 */
void vbe_emergency_text_mode(void) {
    // Write VGA registers to switch to text mode 3 (80x25)
    // This is a simplified version - may not work on all hardware
    
    // Sequencer registers
    outb(0x3C4, 0x00); outb(0x3C5, 0x03);
    outb(0x3C4, 0x01); outb(0x3C5, 0x00);
    outb(0x3C4, 0x02); outb(0x3C5, 0x03);
    outb(0x3C4, 0x03); outb(0x3C5, 0x00);
    outb(0x3C4, 0x04); outb(0x3C5, 0x02);
    
    // Misc register
    outb(0x3C2, 0x67);
    
    // CRTC registers (text mode)
    outb(0x3D4, 0x11); outb(0x3D5, inb(0x3D5) & 0x7F);  // Unlock
    
    // Graphics controller
    outb(0x3CE, 0x05); outb(0x3CF, 0x10);  // Text mode
    outb(0x3CE, 0x06); outb(0x3CF, 0x0E);  // Memory map B8000
    
    // Clear text screen
    vga_clear();
}
